{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}Category{% endblock %}</h1>

{% endblock %}

{% block content %}

<section>
    <a href="javascript:history.back()" class="btn btn-secondary">Back to previous page</a>
</section>

<section class="text-left">
    <!-- <table id="table"></table> -->
    <table id="table" class="display" cellspacing="0">
        <thead>
            <tr>
                <th>ID</th>
                <th>{{ form.key.label }}</th>
                <th>{{ form.category.label }}</th>
                <th>{{ form.destinationAcc.label }}</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>ID</th>
                <th>{{ form.key.label }}</th>
                <th>{{ form.category.label }}</th>
                <th>{{ form.destinationAcc.label }}</th>
            </tr>
        </tfoot>
    </table>
</section>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Delete categoty with Description <b id="desc_text"></b>.
                Confirm?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="delete_action()">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_script %}
<script>
    var _table;
    var _id;

    let edit_func = async (api, datatable, method) => {
        const fields = {
            csrf_token: {
                input: document.getElementById("csrf_token"),
                error: document.getElementById("csrf_token-error"),
            },
            key: {
                input: document.getElementById("key"),
                error: document.getElementById("key-error"),
            },
            category: {
                input: document.getElementById("category"),
                error: document.getElementById("category-error"),
            },
            destinationAcc: {
                input: document.getElementById("destinationAcc"),
                error: document.getElementById("destinationAcc-error"),
            }
        };

        let formData = new FormData();

        formData.append('csrf_token', fields.csrf_token.input.value);
        formData.append('key', fields.key.input.value);
        formData.append('category', fields.category.input.value);
        formData.append('destinationAcc', fields.destinationAcc.input.value);

        const response = await fetch(api, {
            method: method,
            body: formData,
        })

        if (response.ok) {
            dlg.close();
            await response.json().then((data) => {
                $.alert(data.message);
            })
            datatable.ajax.reload(null, false);
            $('#table').trigger('deselect');
        } else {
            const errors = await response.json();
            Object.keys(errors).forEach((key) => {
                fields[key].input.classList.add('is-invalid');
                fields[key].error.innerHTML = errors[key][0];
            });
        }
    }

    $(document).on('submit', '#create_dialog', async (e) => {
        e.preventDefault();
        edit_func('/api/category', $('#table').DataTable(), 'POST');
    });

    $(document).on('submit', '#edit_dialog', async (e) => {
        e.preventDefault();
        edit_func('/api/category?id=' + _id, $('#table').DataTable(), 'PUT');
    });

    $(document).ready(function () {
        $('th').addClass('text-left');
        _table = $('#table').DataTable({
            'ajax': {
                "type": "GET",
                "url": '/api/category',
            },
            columnDefs: [
                {
                    target: 0,
                    visible: false,
                    searchable: false
                }
            ],
            "columns": [
                { "data": "id" },
                { "data": "key" },
                { "data": "category" },
                { "data": "destinationAcc" },
            ],
            layout: {
                topStart: {
                    buttons: [
                        {
                            text: 'Create',
                            action: function (e) {
                                e.stopPropagation();
                                dlg = $.confirm({
                                    title: 'Create',
                                    content: function (e) {
                                        var tmp = null;
                                        $.get({
                                            async: false,
                                            url: '/category/dialog',
                                            statusCode: {
                                                200: function (data) {
                                                    tmp = data;
                                                }
                                            }
                                        })
                                        return tmp;
                                    },
                                    buttons: {
                                        OK: {
                                            text: 'OK',
                                            btnClass: 'btn btn-primary',
                                            action: function () {
                                                $('#create_dialog').submit();
                                                return false;
                                            }
                                        },
                                        Cancel: {
                                            text: 'Cancel',
                                            btnClass: 'btn btn-danger'
                                        }
                                    }
                                })
                            }
                        },
                        {
                            text: 'Edit',
                            action: function (e) {
                                e.stopPropagation();
                                let _d = _table.rows({ selected: true }).data();
                                _id = _d[0].id;
                                dlg = $.confirm({
                                    title: 'Edit',
                                    content: function (e) {
                                        var tmp = null;
                                        $.get({
                                            async: false,
                                            url: '/category/dialog/' + _id,
                                            statusCode: {
                                                200: function (data) {
                                                    tmp = data;
                                                }
                                            }
                                        })
                                        return tmp;
                                    },
                                    buttons: {
                                        OK: {
                                            text: 'OK',
                                            btnClass: 'btn btn-primary',
                                            action: function () {
                                                $('#edit_dialog').submit();
                                                return false;
                                            }
                                        },
                                        Cancel: {
                                            text: 'Cancel',
                                            btnClass: 'btn btn-danger'
                                        }
                                    }
                                })
                            },
                            enabled: false,
                        },
                        {
                            text: 'Delete',
                            action: function (e) {
                                e.stopPropagation();
                                let _d1 = _table.rows({ selected: true }).data();
                                let _id = _d1[0].id;
                                $.confirm({
                                    title: 'Confirm',
                                    content: 'Delete the selected record?',
                                    buttons: {
                                        confirm: function () {
                                            let _url = `{{url_for('category.category', id='var_1')}}`.replace('var_1', _id);
                                            let _payload = {
                                                'id': _id,
                                            }
                                            $.ajax({
                                                url: _url,
                                                type: 'DELETE',
                                                statusCode: {
                                                    201: function (result) {
                                                        $.alert(result.message);
                                                        $('#table').DataTable().ajax.reload(null, false);
                                                    }
                                                }
                                            });
                                        },
                                        cancel: function () {
                                            return true;
                                        },
                                    }
                                });
                            },
                            enabled: false,
                        }
                    ]
                }
            },
            select: true,
        });
        _table.on('select deselect', function () {
            var selectedRows = _table.rows({ selected: true }).count();

            _table.button(1).enable(selectedRows === 1);
            _table.button(2).enable(selectedRows === 1);
        });
    })
</script>
{% endblock %}